# Project Status - Albopictus Diapause RNA-seq Analysis

**Last Updated:** 2025-10-16  
**Current Phase:** Post-RNAseq Processing / QC Analysis

## Project Overview
- **Goal:** Validate 34 GWAS candidate genes for diapause regulation in *Aedes albopictus*
- **Datasets:** 3 independent experiments (PRJNA268379, PRJNA158021, PRJNA187045)
- **Challenge:** Replicating collaborator's results from published manuscripts

## Completed Tasks âœ…

### 1. Data Acquisition (Completed)
- Downloaded all SRA data for 3 projects
- Total samples: 44 (16 from PRJNA268379, 12 from PRJNA158021, 16 from PRJNA187045)
- Data stored in: `data/raw/`

### 2. Reference Preparation (Completed)
- Downloaded *Aedes albopictus* reference genome: `data/references/albo.fasta.gz`
- Fixed GTF annotation: `data/references/genes_fixed.rsem.fixed.gtf`

### 3. RNA-seq Pipeline (Completed July 2025)
- Ran nf-core/rnaseq v3.19.0 using array job (44 samples)
- All 44 jobs completed successfully
- Used Salmon for quantification (not STAR alignment)
- Outputs in: `output/PRJNA*/SRR*/`

### 4. Infrastructure Setup (Completed)
- Created Singularity container: `albopictus-diapause-rnaseq.sif`
- Container available on Docker Hub and GitHub Container Registry
- Set up for both HPC and local analysis

## Current Status ðŸ”„

### QC Analysis Strategy (Updated Oct 16, 2025)
**Focus**: Extract and report QC metrics from completed nf-core runs for manuscript

**Available Data**:
- All 44 samples processed successfully through nf-core/rnaseq
- QC data already generated by pipeline in standardized formats
- Container verified working with mount point at `/proj`

**Immediate Tasks**:
1. Extract QC metrics from MultiQC reports for all 44 samples
2. Create manuscript-ready QC summary tables
3. Generate standard QC figures (depth, mapping rates, PCA)
4. Assess data quality and identify any problematic samples

### Analysis Plan

#### Phase 1: QC Assessment (Completed!)
- [x] Create results directory structure (`results/01_qc_analysis/`)
- [x] Create comprehensive analysis strategy document
- [x] Clone collaborator GitHub repository (srmarzec/albopictus_remapping)
- [x] Create analysis comparison document
- [x] Extract metrics from `multiqc_general_stats.txt` files
- [x] Compile mapping statistics across all samples (see results/01_qc_analysis/)
- [x] Generate QC figures (PDF files in results/01_qc_analysis/figures/)
- [ ] Fix gene count detection (currently showing 0 genes)
- [ ] Check for batch effects between projects/platforms
- [ ] Create final QC report for reviewers

**QC Results Summary (Oct 16, 2025):**
- All 44 samples successfully processed
- Average mapping rate: 80-91% (good quality)
- Read counts: 11.9M (embryos), 18.8M (larvae), 28.1M (adults)
- Need to fix gene detection counts in script

#### Phase 2: Count Matrix Preparation
- [ ] Gather `salmon.merged.gene_counts.tsv` from all samples
- [ ] Create combined count matrices by project
- [ ] Import 34 GWAS candidate genes list
- [ ] Verify gene IDs match annotation

#### Phase 3: Differential Expression
- [ ] Review collaborator's original DE scripts and methods
- [ ] Run DESeq2 per project with appropriate models
- [ ] Document model choices for reviewers
- [ ] Extract results for candidate genes
- [ ] Compare with collaborator's published results
- [ ] Address reviewer concerns about statistical models

#### Phase 4: Meta-analysis
- [ ] Integrate results across life stages
- [ ] Account for platform differences (GAIIx vs HiSeq2000)
- [ ] Prioritize candidate genes by consistency
- [ ] Prepare publication figures and tables

#### Phase 5: Reproducibility Package
- [ ] Reorganize scripts directory for clarity
- [ ] Update Dockerfile with complete analysis pipeline
- [ ] Include SRA download and nf-core scripts
- [ ] Create container with processed data option
- [ ] Write comprehensive methods documentation

## Using the Singularity Container

### Loading the Module
```bash
module load singularity/3.9.3
```

### Running Scripts with the Container
The container mounts the project directory to `/proj` inside the container.

**Interactive shell:**
```bash
singularity shell --cleanenv --bind $PWD:/proj albopictus-diapause-rnaseq.sif
# Inside container:
cd /proj
python scripts/03_qc_analysis/extract_qc_metrics.py
```

**Execute a command:**
```bash
singularity exec --cleanenv --bind $PWD:/proj albopictus-diapause-rnaseq.sif \
    bash -c "cd /proj && python scripts/03_qc_analysis/extract_qc_metrics.py"
```

### Container Details
- **Image**: `albopictus-diapause-rnaseq.sif` (1.3GB)
- **Mount point**: Project directory â†’ `/proj`
- **Installed tools**: Python 3.10, R 4.3, pandas, matplotlib, seaborn, DESeq2, etc.
- **Working directory**: Always `cd /proj` after entering container

## Key Files and Locations

### Quantification Results
- Salmon quant files: `output/PRJNA*/SRR*/star_salmon/quant.sf`
- Gene counts: `output/PRJNA*/SRR*/star_salmon/salmon.merged.gene_counts.tsv`
- FeatureCounts: `output/PRJNA*/SRR*/star_salmon/featurecounts/*.tsv`

### QC Reports
- MultiQC: `output/PRJNA*/SRR*/multiqc/star_salmon/multiqc_report.html`
- FastQC: `output/PRJNA*/SRR*/fastqc/`
- Qualimap: `output/PRJNA*/SRR*/star_salmon/qualimap/`

### Logs
- SLURM logs: `logs/slurm_rnaseq/`
- SRA download logs: `logs/sra_download/`
- Nextflow logs: `logs/nextflow/`

## Known Issues
1. **Candidate genes list is empty** - Need to populate with 34 GWAS genes
2. **Replication challenges** - Previous attempts to replicate collaborator results failed
3. **Cross-platform batch effects** - Different sequencing platforms (GAIIx vs HiSeq2000)

## Experimental Design Summary

### PRJNA268379 (Adult Females)
- 2Ã—2 factorial: Photoperiod (LD/SD) Ã— Blood meal (NBF/BF)
- 4 replicates per condition = 16 samples
- Platform: HiSeq2000

### PRJNA158021 (Embryos)
- Time course: 72-78h and 135-141h post-oviposition
- Conditions: Diapause vs Non-diapause
- Platform: GAIIx

### PRJNA187045 (Pharate Larvae)
- Time course: 11, 21, 40 days post-oviposition
- Conditions: Diapause vs Quiescence
- Platform: HiSeq2000

## Notes
- All Nextflow runs used consistent parameters (see `scripts/02_run_rnaseq/01_run_rnaseq_array.sh`)
- Skipped some QC steps to speed up processing (bigwig, stringtie, dupradar, preseq)
- Saved trimmed reads and unaligned reads for potential re-analysis

## RNA-seq Analysis Strategy

### IMPORTANT: All commands must be run inside the Singularity container!

```bash
# Always start with:
module load singularity/3.9.3
cd /bigdata/cosmelab/lcosme/projects/albopictus-diapause-rnaseq
singularity shell --cleanenv --bind $PWD:/proj albopictus-diapause-rnaseq.sif
cd /proj
```

### Standard RNA-seq Workflow
Following the scientific standard for RNA-seq analysis:

1. **QC Assessment** (Current Stage)
   - nf-core has already generated QC data in:
     - `output/PRJNA*/SRR*/multiqc/star_salmon/multiqc_report_data/`
     - `output/PRJNA*/SRR*/star_salmon/qualimap/`
     - `output/PRJNA*/SRR*/star_salmon/rseqc/`
   
   - Standard QC metrics to extract and report:
     - Total reads (from multiqc_general_stats.txt)
     - Mapping rate (>80% expected)
     - Uniquely mapped % vs multi-mapped %
     - Gene body coverage (5'/3' bias from qualimap)
     - rRNA contamination (from featurecounts biotype)
     - Insert size distribution
     - Duplication rate
     - Gene detection (# genes >10 counts)
   
   - Standard QC figures for manuscript:
     - Sequencing depth bar chart
     - Mapping rate stacked bar chart  
     - PCA plot of samples
     - Correlation heatmap
     - Gene body coverage plot

2. **Count Matrix Preparation**
   - Use Salmon outputs (already generated by nf-core)
   - Available files per sample:
     - `quant.sf` - transcript-level quantification
     - `salmon.merged.gene_counts.tsv` - gene-level counts
     - `salmon.merged.gene_tpm.tsv` - gene-level TPM
   - Combine into project-level matrices

3. **Differential Expression Analysis**
   - **Per-project analysis first** (following collaborator's approach):
     - PRJNA268379: Adult females (2Ã—2 factorial: photoperiod Ã— blood meal)
     - PRJNA158021: Embryos (time course with diapause vs non-diapause)
     - PRJNA187045: Pharate larvae (diapause vs quiescence over time)
   - Use DESeq2 with appropriate models for each experiment
   - Apply standard thresholds (FDR < 0.05, |log2FC| > 1)

4. **Meta-analysis**
   - Combine results across life stages
   - Account for batch effects (different platforms: GAIIx vs HiSeq2000)
   - Focus on 34 GWAS candidate genes

5. **Publication Outputs**
   - Supplementary data files for reproducibility
   - Standard figures: volcano plots, MA plots, heatmaps
   - Gene set enrichment analysis

### Working with the Container

**Important**: All Python/R scripts should be run inside the container to ensure reproducibility.

```bash
# Always start with:
module load singularity/3.9.3
cd /bigdata/cosmelab/lcosme/projects/albopictus-diapause-rnaseq

# Interactive mode (for development/testing):
singularity shell --cleanenv --bind $PWD:/proj albopictus-diapause-rnaseq.sif
cd /proj
# Now you can run Python/R scripts with all dependencies available

# Script execution mode:
singularity exec --cleanenv --bind $PWD:/proj albopictus-diapause-rnaseq.sif \
    bash -c "cd /proj && python scripts/script_name.py"
```

### Directory Structure (Simplified)

```
results/
â”œâ”€â”€ 01_qc_analysis/
â”‚   â”œâ”€â”€ metrics/        # Extracted QC data (CSV/JSON)
â”‚   â”œâ”€â”€ figures/        # QC plots
â”‚   â””â”€â”€ tables/         # Summary tables
â”œâ”€â”€ 02_count_matrices/
â”‚   â”œâ”€â”€ gene_counts/    # Combined count matrices
â”‚   â””â”€â”€ gene_tpm/       # Combined TPM matrices
â”œâ”€â”€ 03_de_analysis/
â”‚   â”œâ”€â”€ PRJNA268379/    # Per-project DE results
â”‚   â”œâ”€â”€ PRJNA158021/
â”‚   â””â”€â”€ PRJNA187045/
â””â”€â”€ 04_meta_analysis/   # Cross-project integration
```

This structure follows the analysis flow and is easier to understand.